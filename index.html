<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>朝ダッシュ！ | 兄弟で楽しくモーニング</title>
<meta name="theme-color" content="#4f46e5" />
<style>
  :root{
    --bg:#fffef9; --card:#ffffff; --ink:#12131a; --muted:#767b85;
    --accent:#4f46e5; --accent2:#22c55e; --danger:#ef4444;
    --barbg:#eef0f3; --shadow:0 8px 22px rgba(0,0,0,.07);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fffef9 85%,#fff0);backdrop-filter:saturate(1.1) blur(4px);padding:10px 10px 6px;border-bottom:1px solid #f1f2f4}
  .row{display:flex;gap:10px;align-items:center}
  .space{justify-content:space-between}
  h1{font-size:18px;margin:0}
  .sub{font-size:12px;color:#667085}
  .timer{font-variant-numeric:tabular-nums;font-size:28px;font-weight:800;letter-spacing:.3px}
  .muted{color:var(--muted);font-size:12px}
  .bar{height:8px;background:var(--barbg);border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:var(--accent);width:0%}
  .wrap{padding:10px;max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid #eef0f3;border-radius:14px;box-shadow:var(--shadow);padding:10px;margin:8px 0}
  .controls{gap:8px}
  input[type=time]{font-size:15px;border:1px solid #e5e7eb;border-radius:10px;padding:6px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:800}
  button.secondary{background:#e5e7eb;color:#111}
  button.ghost{background:transparent;color:var(--muted)}
  /* ---- 兄弟を常時2列 ---- */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kid{display:flex;flex-direction:column;gap:8px;min-height:100%}
  .kid h2{font-size:15px;margin:2px 2px}
  ul.tasks{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  li.task{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;border:1px solid #eef0f3;border-radius:12px;padding:10px 12px;background:#fff}
  .icon{font-size:20px;width:26px;text-align:center}
  .title{font-weight:800;font-size:15px}
  .due{font-size:11px;color:#374151;background:#f3f4f6;border-radius:999px;padding:3px 8px;margin-left:6px}
  .done .title{text-decoration:line-through;opacity:.65}
  .progress{height:6px;background:#f2f3f6;border-radius:999px;overflow:hidden;margin-top:6px}
  .progress > span{display:block;height:100%;background:var(--accent2);width:0%}
  .nav{font-size:11px;color:#0a0a0a;background:#eef7ff;border-left:4px solid #60a5fa;padding:6px 8px;border-radius:10px;margin-top:4px}
  .btn-big{font-size:16px;padding:12px 14px;border-radius:14px;min-width:88px}
  .star{font-size:18px}
  .cele{position:fixed;inset:0;pointer-events:none}
  .history{font-size:13px}
  .weekly{display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;background:#f3f4f6;color:#111;border-radius:999px;padding:4px 10px}
</style>
</head>
<body>
  <header>
    <div class="row space">
      <div>
        <h1>朝ダッシュ！</h1>
        <div class="sub">7:00までに準備しよう</div>
      </div>
      <div class="row controls">
        <label class="muted">出発</label>
        <input type="time" id="departAt" />
        <button class="secondary" id="resetDay">今日の進捗リセット</button>
      </div>
    </div>
    <div class="card">
      <div class="row space">
        <div>
          <div class="muted">出発まで</div>
          <div id="countdown" class="timer">--:--</div>
        </div>
        <div class="row weekly">
          <div class="star" id="stars">⭐ 0</div>
          <div class="pill" id="weekly">今週：⭐ 0 / 7</div>
          <div id="crown" style="font-size:20px;display:none">👑</div>
        </div>
      </div>
      <div class="bar" aria-label="残り時間"><span id="timeBar"></span></div>
      <div class="muted" id="windowHint" style="margin-top:6px"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid2">
      <section class="kid card" id="kidA">
        <h2>おねえちゃん</h2>
        <ul class="tasks" id="tasksA"></ul>
        <div class="nav" id="nextA">次は —</div>
      </section>
      <section class="kid card" id="kidB">
        <h2>おとうと</h2>
        <ul class="tasks" id="tasksB"></ul>
        <div class="nav" id="nextB">次は —</div>
      </section>
    </div>

    <section class="card">
      <h3 style="margin:6px 2px">履歴</h3>
      <div class="history" id="history"></div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <button class="ghost" id="clearHistory">履歴を全消去</button>
      </div>
    </section>
  </main>

  <canvas id="cele" class="cele"></canvas>

<script>
/* ====== 設定・初期値 ====== */
const KEY="asadash_v7";
const START_HOUR=6;
const DEFAULT_DEPART="07:00";
const TASKS_DEF=[
  {id:"meal",  title:"あさごはん", icon:"🍞", due:"06:10"},
  {id:"hyg",   title:"はみがき・かお・トイレ", icon:"🧼", due:"06:30"},
  {id:"dress", title:"きがえ", icon:"👕", due:"06:45"},
  {id:"bag",   title:"にもつチェック", icon:"🎒", due:"06:50"},
];
const KIDS=["A","B"];

/* ====== JSTユーティリティ ====== */
const JST_OFFSET = 9 * 60; // minutes
function nowJST(){
  const now = new Date();
  const utcMs = now.getTime() + now.getTimezoneOffset()*60000;
  return new Date(utcMs + JST_OFFSET*60000);
}
function dateAtJST(hh,mm, baseDate){
  const d = baseDate ? new Date(baseDate) : nowJST();
  const j = new Date(d.getTime()); j.setHours(hh, mm, 0, 0); return j;
}
function parseHM(hm){ const [h,m]=hm.split(":").map(Number); return {h,m}; }
function fmtHM(d){const h=String(d.getHours()).padStart(2,"0"), m=String(d.getMinutes()).padStart(2,"0"); return `${h}:${m}`;}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

/* ====== 週キー（JST・月曜開始） ====== */
function weekKeyJST(d){
  const date = new Date(d.getTime());
  const day = (date.getDay()+6)%7; // Mon=0
  const monday = new Date(date); monday.setDate(date.getDate()-day);
  const y = monday.getFullYear();
  const m = String(monday.getMonth()+1).padStart(2,'0');
  const dd= String(monday.getDate()).padStart(2,'0');
  return `${y}-W${m}${dd}`;
}

/* ====== 状態 ====== */
const todayStr=()=>{const d=nowJST(); return d.toISOString().slice(0,10)};
const dayKey=()=>`${KEY}:${todayStr()}`;
function defaultState(){
  const baseTasks=()=>TASKS_DEF.map(t=>({...t, done:false, p:0, ts:null}));
  const wk = { key: weekKeyJST(nowJST()), count: 0 };
  const savedWk = JSON.parse(localStorage.getItem(KEY+":week")||"null");
  const week = (savedWk && savedWk.key===wk.key) ? savedWk : wk;
  return {
    depart: localStorage.getItem(KEY+":lastDepart") || DEFAULT_DEPART,
    stars: Number(localStorage.getItem(KEY+":stars")||0),
    week,
    kids:{
      A:{ name:"おねえちゃん", tasks:baseTasks(), startedAt:null, finishedAt:null },
      B:{ name:"おとうと",     tasks:baseTasks(), startedAt:null, finishedAt:null },
    },
    history: JSON.parse(localStorage.getItem(KEY+":history")||"[]"),
    best: JSON.parse(localStorage.getItem(KEY+":best")||"null"),
  };
}
let state = JSON.parse(localStorage.getItem(dayKey())||"null") || defaultState();

/* ====== DOM ====== */
const $depart=document.getElementById("departAt");
const $count=document.getElementById("countdown");
const $bar=document.getElementById("timeBar");
const $hint=document.getElementById("windowHint");
const $stars=document.getElementById("stars");
const $weekly=document.getElementById("weekly");
const $crown=document.getElementById("crown");
const $tasksA=document.getElementById("tasksA");
const $tasksB=document.getElementById("tasksB");
const $nextA=document.getElementById("nextA");
const $nextB=document.getElementById("nextB");
const $hist=document.getElementById("history");
const $reset=document.getElementById("resetDay");
const $clearHist=document.getElementById("clearHistory");

/* ====== 保存 ====== */
function persist(){
  localStorage.setItem(dayKey(), JSON.stringify(state));
  localStorage.setItem(KEY+":lastDepart", state.depart);
  localStorage.setItem(KEY+":stars", String(state.stars));
  localStorage.setItem(KEY+":history", JSON.stringify(state.history));
  localStorage.setItem(KEY+":best", JSON.stringify(state.best));
  localStorage.setItem(KEY+":week", JSON.stringify(state.week));
}

/* ====== タスク描画 ====== */
function renderKid(kidId, $list, $next){
  $list.innerHTML="";
  const k=state.kids[kidId];
  k.tasks.forEach((t)=>{
    const li=document.createElement("li"); li.className="task"+(t.done?" done":"");
    li.innerHTML=`
      <div class="icon">${t.icon}</div>
      <div>
        <div class="title">${t.title}<span class="due">〜${t.due}</span></div>
        <div class="progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${t.p}"><span style="width:${t.p}%"></span></div>
      </div>
      <div><button class="secondary btn-big" data-act="toggle">${t.done?"もどす":"できた！"}</button></div>
    `;
    li.querySelector("button").addEventListener("click",()=>{
      const now = nowJST();
      if (!k.startedAt) k.startedAt=now.toISOString();
      t.done=!t.done; t.p=t.done?100:0; t.ts = t.done ? now.toISOString() : null;
      sfx("done"); sprinkle(li);
      const next = k.tasks.find(x=>!x.done);
      $next.textContent = next ? `次は「${next.title}」だよ！` : `全部できた！おつかれさま！`;
      if (allKidsDone()){ celebrate(); recordHistory(); }
      persist(); render();
    });
    $list.appendChild(li);
  });
  const nxt=k.tasks.find(x=>!x.done);
  $next.textContent = nxt ? `次は「${nxt.title}」だよ！` : `全部できた！おつかれさま！`;
}

function renderHistory(){
  const items = state.history.slice(-7).reverse();
  if (items.length===0){ $hist.textContent="まだ履歴はありません。"; return; }
  $hist.innerHTML = items.map(h=>{
    const bestBadge = (state.best && state.best.finishedAt===h.finishedAt) ? " 🏆ベスト" : "";
    return `<div style="padding:6px 0;border-bottom:1px dashed #eee">
      <div><strong>${h.date}</strong> 完了 ${h.finishedAt}${bestBadge}</div>
      <div class="muted">おねえちゃん: ${h.kids.A.map(x=>`${x.id}:${x.time}`).join(" / ")}</div>
      <div class="muted">おとうと: ${h.kids.B.map(x=>`${x.id}:${x.time}`).join(" / ")}</div>
    </div>`;
  }).join("");
}

function render(){
  const wk = weekKeyJST(nowJST());
  if (state.week.key !== wk){ state.week = {key:wk, count:0}; }
  $depart.value = state.depart;
  $stars.textContent = `⭐ ${state.stars}`;
  $weekly.textContent = `今週：⭐ ${state.week.count} / 7`;
  $crown.style.display = state.week.count>=7 ? "block" : "none";
  renderKid("A",$tasksA,$nextA);
  renderKid("B",$tasksB,$nextB);
  renderHistory();
}

/* ====== 6:00 → 出発（JST）。出発を過ぎていたら翌日にロールオーバー ====== */
function getWindowDates(){
  const now = nowJST();
  const {h:dh, m:dm} = parseHM(state.depart);
  let depart = dateAtJST(dh, dm, now);
  let start  = dateAtJST(START_HOUR, 0, now);
  if (now > depart) { // 夜に開いても巨大マイナスにしない
    depart = new Date(depart.getTime() + 24*3600*1000);
    start  = new Date(start.getTime()  + 24*3600*1000);
  }
  return {now, start, depart};
}

/* ====== カウントダウン＆ゲージ ====== */
function timerTick(){
  const {now, start, depart} = getWindowDates();
  const ms = depart - now; // ロールオーバー済だから >=0
  const m = Math.floor(ms/60000);
  const s = Math.floor((ms%60000)/1000);
  $count.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  const total = depart - start;
  const pct = clamp((ms/total)*100, 0, 100);
  $bar.style.width = `${pct}%`;
  $hint.textContent = `いまの時間の窓：${fmtHM(start)} → ${fmtHM(depart)}（JST / 出発は変更可）`;
}
setInterval(timerTick, 250);

/* ====== 効果音・演出（派手め） ====== */
let audioCtx;
function sfx(type="click"){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const tones = {done:[660,740,830,990,1110], win:[880,1040,1240,1480], click:[520,600,680]};
    const f = (tones[type]||[600])[Math.floor(Math.random()* (tones[type]||[600]).length)];
    o.frequency.value = f; g.gain.value=.08;
    const t=audioCtx.currentTime; const dur = type==="win" ? 0.26 : 0.12;
    o.start(t); o.stop(t+dur);
  }catch(e){}
}
const canvas=document.getElementById("cele"); const ctx=canvas.getContext("2d");
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight } addEventListener("resize",resize); resize();
let parts=[];
function sprinkle(el){
  const r=el.getBoundingClientRect();
  const x=r.left+r.width/2, y=r.top+scrollY;
  for(let i=0;i<32;i++){
    parts.push({x,y,vx:(Math.random()-0.5)*5,vy:Math.random()*-6-2,g:.18,size:Math.random()*5+2,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa","#f472b6","#10b981"][i%7],ttl:110});
  }
}
function burstCenter(){
  const x=innerWidth/2, y=84;
  for(let i=0;i<200;i++){
    parts.push({x,y,vx:(Math.random()-0.5)*8,vy:Math.random()*-8-2,g:.12,size:Math.random()*6+3,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa","#f472b6","#10b981"][i%7],ttl:180});
  }
}
function anim(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  parts.forEach(p=>{
    p.ttl--; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy;
    ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size);
  });
  parts = parts.filter(p=>p.ttl>0 && p.y<canvas.height+30);
  requestAnimationFrame(anim);
}
anim();

/* ====== 完了判定・履歴・週ごほうび ====== */
function allKidsDone(){ return KIDS.every(k=>state.kids[k].tasks.every(t=>t.done)); }
function celebrate(){
  state.stars += 1;
  const wk = weekKeyJST(nowJST());
  if (state.week.key !== wk){ state.week = {key:wk, count:0}; }
  state.week.count = Math.min(7, state.week.count + 1);
  sfx("win"); burstCenter();
  if (state.week.count>=7){ $crown.style.display="block"; }
}
function recordHistory(){
  const now = nowJST();
  const recKids = {};
  KIDS.forEach(kid=>{
    const k=state.kids[kid];
    k.finishedAt = k.finishedAt || now.toISOString();
    recKids[kid] = k.tasks.map(t=>({id:t.id, time: t.ts ? t.ts.slice(11,16) : "--:--"}));
  });
  const finishedHM = fmtHM(now);
  const rec = {date: todayStr(), finishedAt: finishedHM, kids: recKids};
  state.history.push(rec);
  const toMin=hm=>{const [h,m]=hm.split(":").map(Number); return h*60+m;}
  if (!state.best || toMin(finishedHM) < toMin(state.best.finishedAt)){
    state.best = {date: rec.date, finishedAt: finishedHM};
  }
  persist(); renderHistory(); render();
}

/* ====== イベント ====== */
$depart.addEventListener("change",()=>{ state.depart = $depart.value || DEFAULT_DEPART; persist(); timerTick(); });
$reset.addEventListener("click",()=>{
  if(!confirm("今日の進捗をリセットしますか？")) return;
  ["A","B"].forEach(kid=>{
    const k=state.kids[kid];
    k.tasks = TASKS_DEF.map(t=>({...t, done:false, p:0, ts:null}));
    k.startedAt=null; k.finishedAt=null;
  });
  persist(); render();
});
$clearHist.addEventListener("click",()=>{ if(!confirm("履歴をすべて削除しますか？")) return; state.history=[]; state.best=null; persist(); renderHistory(); });

/* ====== 初期描画 ====== */
(function init(){ if (!state.depart) state.depart = DEFAULT_DEPART; persist(); render(); timerTick(); })();
</script>
</body>
</html>