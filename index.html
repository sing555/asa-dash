<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœãƒ€ãƒƒã‚·ãƒ¥ï¼ | å…„å¼Ÿã§æ¥½ã—ããƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°</title>
<meta name="theme-color" content="#4f46e5" />
<style>
  :root{
    --bg:#fffef9; --card:#ffffff; --ink:#12131a; --muted:#767b85;
    --accent:#4f46e5; --accent2:#22c55e; --danger:#ef4444;
    --barbg:#eef0f3; --shadow:0 10px 28px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fffef9 80%,#fff0);backdrop-filter:saturate(1.1) blur(4px);padding:14px 14px 8px;border-bottom:1px solid #f1f2f4}
  .row{display:flex;gap:12px;align-items:center}
  .space{justify-content:space-between}
  h1{font-size:18px;margin:0}
  .timer{font-variant-numeric:tabular-nums;font-size:32px;font-weight:800;letter-spacing:.3px}
  .late{color:var(--danger)}
  .muted{color:var(--muted);font-size:12px}
  .bar{height:10px;background:var(--barbg);border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:var(--accent);width:0%}
  .wrap{padding:12px;max-width:980px;margin:0 auto}
  .card{background:var(--card);border:1px solid #eef0f3;border-radius:16px;box-shadow:var(--shadow);padding:12px;margin:10px 0}
  .controls{gap:10px}
  input[type=time]{font-size:16px;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:700}
  button.secondary{background:#e5e7eb;color:#111}
  button.ghost{background:transparent;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:680px){ .grid{grid-template-columns:1fr 1fr} }
  .kid{display:flex;flex-direction:column;gap:10px}
  .kid h2{font-size:16px;margin:4px 2px}
  ul.tasks{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}
  li.task{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid #eef0f3;border-radius:14px;padding:10px 12px;background:#fff}
  .icon{font-size:22px;width:28px;text-align:center}
  .title{font-weight:700}
  .due{font-size:11px;color:#374151;background:#f3f4f6;border-radius:999px;padding:3px 8px;margin-left:8px}
  .done .title{text-decoration:line-through;opacity:.6}
  .progress{height:6px;background:#f2f3f6;border-radius:999px;overflow:hidden;margin-top:6px}
  .progress > span{display:block;height:100%;background:var(--accent2);width:0%}
  .nav{font-size:12px;color:#0a0a0a;background:#eef7ff;border-left:4px solid #60a5fa;padding:6px 8px;border-radius:10px;margin-top:4px}
  .star{font-size:20px}
  .cele{position:fixed;inset:0;pointer-events:none}
  .center{display:flex;align-items:center;gap:10px}
  .footer{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#ffffffcc;border-top:1px solid #eee;backdrop-filter:blur(6px)}
  .history{font-size:13px}
</style>
</head>
<body>
  <header>
    <div class="row space">
      <div>
        <h1>æœãƒ€ãƒƒã‚·ãƒ¥ï¼</h1>
        <div class="muted">å…„å¼Ÿã§æ¥½ã—ãã€7:00å‡ºç™ºã¾ã§ã«æº–å‚™ã‚’ã‚„ã‚Šåˆ‡ã‚ã†</div>
      </div>
      <div class="row controls">
        <label class="muted">å‡ºç™º</label>
        <input type="time" id="departAt" />
        <button class="secondary" id="resetDay">ä»Šæ—¥ã®é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <div class="card">
      <div class="row space">
        <div>
          <div class="muted">å‡ºç™ºã¾ã§</div>
          <div id="countdown" class="timer">--:--</div>
        </div>
        <div class="center">
          <div class="star" id="stars">â­ 0</div>
        </div>
      </div>
      <div class="bar" aria-label="æ®‹ã‚Šæ™‚é–“"><span id="timeBar"></span></div>
      <div class="muted" id="windowHint" style="margin-top:6px"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="kid card" id="kidA">
        <h2>ãŠã­ãˆã¡ã‚ƒã‚“</h2>
        <ul class="tasks" id="tasksA"></ul>
        <div class="nav" id="nextA">æ¬¡ã¯ â€”</div>
      </section>
      <section class="kid card" id="kidB">
        <h2>ãŠã¨ã†ã¨</h2>
        <ul class="tasks" id="tasksB"></ul>
        <div class="nav" id="nextB">æ¬¡ã¯ â€”</div>
      </section>
    </div>

    <section class="card">
      <h3 style="margin:6px 2px">å±¥æ­´</h3>
      <div class="history" id="history"></div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <button class="ghost" id="clearHistory">å±¥æ­´ã‚’å…¨æ¶ˆå»</button>
      </div>
    </section>
  </main>

  <canvas id="cele" class="cele"></canvas>

<script>
/* ====== è¨­å®šãƒ»åˆæœŸå€¤ ====== */
const KEY="asadash_v4";
const START_HOUR=6; // 6:00å›ºå®šï¼ˆã‚²ãƒ¼ã‚¸ã®åŸºæº–ï¼‰
const DEFAULT_DEPART="07:00";
const TASKS_DEF=[
  {id:"meal",  title:"ã‚ã•ã”ã¯ã‚“", icon:"ğŸ", due:"06:10"},
  {id:"hyg",   title:"ã¯ã¿ãŒããƒ»ã‹ãŠãƒ»ãƒˆã‚¤ãƒ¬", icon:"ğŸ§¼", due:"06:30"},
  {id:"dress", title:"ããŒãˆ", icon:"ğŸ‘•", due:"06:45"},
  {id:"bag",   title:"ã«ã‚‚ã¤ãƒã‚§ãƒƒã‚¯", icon:"ğŸ’", due:"06:50"},
];
const KIDS=["A","B"]; // A=ãŠã­ãˆã¡ã‚ƒã‚“, B=ãŠã¨ã†ã¨

/* ====== çŠ¶æ…‹ ====== */
const todayStr=()=>{const d=new Date();return d.toISOString().slice(0,10)};
const dayKey=()=>`${KEY}:${todayStr()}`;
function defaultState(){
  const baseTasks=()=>TASKS_DEF.map(t=>({...t, done:false, p:0, ts:null}));
  return {
    depart: localStorage.getItem(KEY+":lastDepart") || DEFAULT_DEPART,
    stars: Number(localStorage.getItem(KEY+":stars")||0),
    kids:{
      A:{ name:"ãŠã­ãˆã¡ã‚ƒã‚“", tasks:baseTasks(), startedAt:null, finishedAt:null },
      B:{ name:"ãŠã¨ã†ã¨", tasks:baseTasks(), startedAt:null, finishedAt:null },
    },
    history: JSON.parse(localStorage.getItem(KEY+":history")||"[]"),
    best: JSON.parse(localStorage.getItem(KEY+":best")||"null"), // {date, finishedAt}
  };
}
let state = JSON.parse(localStorage.getItem(dayKey())||"null") || defaultState();

/* ====== DOM ====== */
const $depart=document.getElementById("departAt");
const $count=document.getElementById("countdown");
const $bar=document.getElementById("timeBar");
const $hint=document.getElementById("windowHint");
const $stars=document.getElementById("stars");
const $tasksA=document.getElementById("tasksA");
const $tasksB=document.getElementById("tasksB");
const $nextA=document.getElementById("nextA");
const $nextB=document.getElementById("nextB");
const $hist=document.getElementById("history");
const $reset=document.getElementById("resetDay");
const $clearHist=document.getElementById("clearHistory");

/* ====== ä¿å­˜ ====== */
function persist(){
  localStorage.setItem(dayKey(), JSON.stringify(state));
  localStorage.setItem(KEY+":lastDepart", state.depart);
  localStorage.setItem(KEY+":stars", String(state.stars));
  localStorage.setItem(KEY+":history", JSON.stringify(state.history));
  localStorage.setItem(KEY+":best", JSON.stringify(state.best));
}

/* ====== æ™‚åˆ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function todayAt(hhmm){ // "06:10" -> Date today
  const [h,m]=hhmm.split(":").map(Number);
  const d=new Date(); d.setHours(h,m,0,0); return d;
}
function fmtHM(d){const h=String(d.getHours()).padStart(2,"0"), m=String(d.getMinutes()).padStart(2,"0"); return `${h}:${m}`;}
function diffMs(a,b){return a-b;}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

/* ====== ã‚¿ã‚¹ã‚¯æç”» ====== */
function renderKid(kidId, $list, $next){
  $list.innerHTML="";
  const k=state.kids[kidId];
  k.tasks.forEach((t,idx)=>{
    const li=document.createElement("li"); li.className="task"+(t.done?" done":"");
    li.innerHTML=`
      <div class="icon">${t.icon}</div>
      <div>
        <div class="title">${t.title}<span class="due">ã€œ${t.due}</span></div>
        <div class="progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${t.p}"><span style="width:${t.p}%"></span></div>
      </div>
      <div>
        <button class="secondary" data-act="toggle">${t.done?"ã‚‚ã©ã™":"ã§ããŸï¼"}</button>
      </div>
    `;
    li.querySelector("button").addEventListener("click",()=>{
      // é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆæœ€åˆã®å®Œäº†ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã‚’é–‹å§‹ã¨ã¿ãªã™ï¼‰
      if (!k.startedAt) k.startedAt=new Date().toISOString();
      t.done=!t.done; t.p=t.done?100:0; t.ts = t.done ? new Date().toISOString() : null;
      sfx("done"); sprinkle(li); // æ¼”å‡º
      // æ¬¡ã‚¿ã‚¹ã‚¯ãƒŠãƒ“
      const next = k.tasks.find(x=>!x.done);
      $next.textContent = next ? `æ¬¡ã¯ã€Œ${next.title}ã€ã ã‚ˆï¼` : `å…¨éƒ¨ã§ããŸï¼ãŠã¤ã‹ã‚Œã•ã¾ï¼`;
      // å®Œäº†ãƒã‚§ãƒƒã‚¯
      if (allKidsDone()){
        celebrate();
        recordHistory();
      }
      persist(); render();
    });
    $list.appendChild(li);
  });
  // åˆæœŸãƒŠãƒ“
  const nxt=k.tasks.find(x=>!x.done);
  $next.textContent = nxt ? `æ¬¡ã¯ã€Œ${nxt.title}ã€ã ã‚ˆï¼` : `å…¨éƒ¨ã§ããŸï¼ãŠã¤ã‹ã‚Œã•ã¾ï¼`;
}

function renderHistory(){
  const items = state.history.slice(-7).reverse(); // ç›´è¿‘7ä»¶
  if (items.length===0){ $hist.textContent="ã¾ã å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
  $hist.innerHTML = items.map(h=>{
    const bestBadge = (state.best && state.best.finishedAt===h.finishedAt) ? " ğŸ†ãƒ™ã‚¹ãƒˆ" : "";
    return `<div style="padding:6px 0;border-bottom:1px dashed #eee">
      <div><strong>${h.date}</strong> å®Œäº† ${h.finishedAt}${bestBadge}</div>
      <div class="muted">ãŠã­ãˆã¡ã‚ƒã‚“: ${h.kids.A.map(x=>`${x.id}:${x.time}`).join(" / ")}</div>
      <div class="muted">ãŠã¨ã†ã¨: ${h.kids.B.map(x=>`${x.id}:${x.time}`).join(" / ")}</div>
    </div>`;
  }).join("");
}

function render(){
  $depart.value = state.depart;
  $stars.textContent = `â­ ${state.stars}`;
  renderKid("A",$tasksA,$nextA);
  renderKid("B",$tasksB,$nextB);
  renderHistory();
}

/* ====== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼†ã‚²ãƒ¼ã‚¸ ====== */
function timerTick(){
  const now=new Date();
  const depart=todayAt(state.depart);
  const start=todayAt(String(START_HOUR).padStart(2,"0")+":00");
  // æ®‹ã‚Š
  let ms = depart - now;
  const neg = ms<0;
  if (neg) ms = -ms;
  const m = Math.floor(ms/60000);
  const s = Math.floor((ms%60000)/1000);
  $count.textContent = `${neg?"-":""}${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  $count.classList.toggle("late", neg);
  // ã‚²ãƒ¼ã‚¸ï¼ˆstartâ†’depart ã®åŒºé–“ã«å¯¾ã™ã‚‹ now ã®ä½ç½®ï¼‰
  const total = depart - start;
  const remain = clamp(depart - now, 0, total);
  const pct = clamp( (remain/total)*100, 0, 100 );
  $bar.style.width = `${pct}%`;
  $bar.style.background = neg ? "var(--danger)" : "var(--accent)";
  $hint.textContent = `ã„ã¾ã®æ™‚é–“ã®çª“ï¼š${fmtHM(start)} â†’ ${fmtHM(depart)}ï¼ˆå¤‰æ›´å¯èƒ½ï¼‰`;
}
setInterval(timerTick, 250);

/* ====== ç¥ç¦æ¼”å‡ºãƒ»åŠ¹æœéŸ³ ====== */
let audioCtx;
function sfx(type="click"){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    // ãƒ©ãƒ³ãƒ€ãƒ éŸ³éšï¼ˆé”æˆæ„Ÿã‚’å¤‰åŒ–ã•ã›ã‚‹ï¼‰
    const base = {done:[660,740,830,990], win:[880,1040,1240], click:[520,600,680]}[type] || [600];
    const f = base[Math.floor(Math.random()*base.length)];
    o.frequency.value = f; g.gain.value=.07;
    const t=audioCtx.currentTime; const dur = type==="win" ? 0.22 : 0.12;
    o.start(t); o.stop(t+dur);
  }catch(e){}
}
const canvas=document.getElementById("cele"); const ctx=canvas.getContext("2d");
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight } addEventListener("resize",resize); resize();
let parts=[];
function sprinkle(el){
  const r=el.getBoundingClientRect();
  const x=r.left+r.width/2, y=r.top+scrollY;
  for(let i=0;i<20;i++){
    parts.push({x,y,vx:(Math.random()-0.5)*4,vy:Math.random()*-5-2,g:.18,size:Math.random()*5+2,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa"][i%5],ttl:100});
  }
}
function burstCenter(){
  const x=innerWidth/2, y=80;
  for(let i=0;i<140;i++){
    parts.push({x,y,vx:(Math.random()-0.5)*7,vy:Math.random()*-7-2,g:.12,size:Math.random()*6+3,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa"][i%5],ttl:160});
  }
}
function anim(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  parts.forEach(p=>{
    p.ttl--; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy;
    ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size);
  });
  parts = parts.filter(p=>p.ttl>0 && p.y<canvas.height+30);
  requestAnimationFrame(anim);
}
anim();

/* ====== ã™ã¹ã¦å®Œäº†ï¼Ÿ ====== */
function allKidsDone(){
  return KIDS.every(kid=>{
    return state.kids[kid].tasks.every(t=>t.done);
  });
}
function celebrate(){
  state.stars += 1;
  sfx("win"); burstCenter();
}

/* ====== å±¥æ­´ãƒ»ãƒ™ã‚¹ãƒˆ ====== */
function recordHistory(){
  const now = new Date();
  // å…„å¼Ÿã®å€‹åˆ¥è¨˜éŒ²
  const recKids = {};
  KIDS.forEach(kid=>{
    const k=state.kids[kid];
    k.finishedAt = k.finishedAt || now.toISOString();
    recKids[kid] = k.tasks.map(t=>{
      return {id:t.id, time: t.ts ? t.ts.slice(11,16) : "--:--"};
    });
  });
  const finishedHM = fmtHM(now);
  const rec = {date: todayStr(), finishedAt: finishedHM, kids: recKids};
  state.history.push(rec);
  // ãƒ™ã‚¹ãƒˆï¼šçµ‚äº†æ™‚åˆ»ãŒæœ€ã‚‚æ—©ã„ï¼ˆ6:00ã‚¹ã‚¿ãƒ¼ãƒˆå‰æã§å˜ç´”æ¯”è¼ƒï¼‰
  const toMin=hm=>{const [h,m]=hm.split(":").map(Number); return h*60+m;}
  if (!state.best || toMin(finishedHM) < toMin(state.best.finishedAt)){
    state.best = {date: rec.date, finishedAt: finishedHM};
  }
  persist(); renderHistory();
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
$depart.addEventListener("change",()=>{
  state.depart = $depart.value || DEFAULT_DEPART;
  persist(); timerTick();
});
$reset.addEventListener("click",()=>{
  if(!confirm("ä»Šæ—¥ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  KIDS.forEach(kid=>{
    const k=state.kids[kid];
    k.tasks = TASKS_DEF.map(t=>({...t, done:false, p:0, ts:null}));
    k.startedAt=null; k.finishedAt=null;
  });
  persist(); render();
});
$clearHist.addEventListener("click",()=>{
  if(!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  state.history=[]; state.best=null; persist(); renderHistory();
});

/* ====== åˆæœŸæç”» ====== */
(function init(){
  // depart åˆæœŸå€¤ã‚»ãƒƒãƒˆï¼ˆæœªè¨­å®šæ™‚ã¯ DEFAULTï¼‰
  if (!state.depart) state.depart = DEFAULT_DEPART;
  persist(); render(); timerTick();
})();
</script>
</body>
</html>
