<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>朝ダッシュ！</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
  :root { --gap: 1rem; }
  .timer{font-variant-numeric:tabular-nums}
  .flash{animation:flash-bg .9s ease-in-out}
  @keyframes flash-bg{0%{background:rgba(255,255,0,0)}25%{background:rgba(255,255,0,.35)}100%{background:rgba(255,255,0,0)}}
  #cele{position:fixed;inset:0;pointer-events:none;z-index:50}
  /* ランドスケープ最適化 */
  @media (orientation:landscape){
    header{padding:.5rem 1rem}
    header h1{font-size:1.25rem}
    #shell{display:grid;grid-template-rows:auto 1fr; height:100svh;}
    #topWrap{padding:.5rem 1rem}
    #topCard{padding:.5rem 1rem}
    #mainGrid{grid-template-columns:1fr 1fr; gap:var(--gap); padding:0 1rem 1rem}
    .kidCard{max-height:calc(100svh - 144px); overflow:auto} /* タイマー分を差し引き */
    .btn{min-height:44px}
  }
</style>
</head>
<body class="bg-gradient-to-br from-yellow-50 to-pink-50 text-gray-900" id="shell">

<header class="bg-pink-500 text-white shadow-md">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-extrabold">🎉 朝ダッシュ！</h1>
      <span id="subtitle" class="text-sm opacity-90">7:00までに準備しよう</span>
    </div>
    <div class="flex items-center gap-3 text-[13px]">
      <div class="flex items-center gap-1">
        <span class="opacity-80">開始</span>
        <input type="time" id="startAt" class="rounded-lg border px-2 py-1 text-gray-900">
      </div>
      <div class="flex items-center gap-1">
        <span class="opacity-80">出発</span>
        <input type="time" id="departAt" class="rounded-lg border px-2 py-1 text-gray-900">
      </div>
    </div>
  </div>
</header>

<section id="topWrap" class="max-w-6xl mx-auto mt-3 px-4">
  <div id="topCard" class="rounded-2xl bg-white shadow p-4 flex flex-wrap items-center gap-4">
    <div class="flex-1 min-w-[220px]">
      <div class="text-xs text-gray-500">出発まで</div>
      <div id="countdown" class="timer text-4xl md:text-5xl font-extrabold">--:--</div>
      <div class="h-3 rounded-full bg-gray-200 overflow-hidden mt-3">
        <div id="timeBar" class="h-3 bg-emerald-500 w-0"></div>
      </div>
      <div id="winHint" class="text-xs text-gray-500 mt-1"></div>
    </div>
    <div class="text-right min-w-24 ml-auto">
      <div id="stars" class="text-3xl">⭐0</div>
      <div class="text-xs text-gray-500 mt-1">タップで増えるよ</div>
    </div>
  </div>
</section>

<main id="mainGrid" class="max-w-6xl mx-auto mt-4 px-4 grid grid-cols-1 md:grid-cols-2 gap-4">

  <section class="kidCard rounded-2xl bg-white shadow p-4" id="kidA">
    <h2 class="text-lg font-black mb-3 text-pink-600">👧 おねえちゃん</h2>
    <ul id="tasksA" class="space-y-3"></ul>
    <div id="nextA" class="mt-3 text-sm text-indigo-600 font-bold"></div>
  </section>

  <section class="kidCard rounded-2xl bg-white shadow p-4" id="kidB">
    <h2 class="text-lg font-black mb-3 text-yellow-600">👦 おとうと</h2>
    <ul id="tasksB" class="space-y-3"></ul>
    <div id="nextB" class="mt-3 text-sm text-indigo-600 font-bold"></div>
  </section>

</main>

<section class="max-w-6xl mx-auto mt-4 px-4">
  <details class="rounded-2xl bg-white shadow p-4" open>
    <summary class="font-bold cursor-pointer">📊 履歴 & グラフ（直近7日）</summary>
    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="col-span-2"><canvas id="histChart" height="140"></canvas></div>
      <div>
        <div id="stats" class="text-sm text-gray-700 mb-2">平均 --:-- / 最速 --:--</div>
        <div id="history" class="space-y-2 text-sm text-gray-700"></div>
        <button id="clearHistory" class="mt-2 text-xs text-gray-500 underline">履歴を全消去</button>
      </div>
    </div>
  </details>
</section>

<canvas id="cele"></canvas>

<script>
/* ===== 設定 / 状態 ===== */
const KEY="asadash_v9_3";
const DEFAULT_START="06:00";
const DEFAULT_DEPART="07:00";
const TASKS=[
  {id:"meal",  title:"あさごはん", icon:"🍞"},
  {id:"hyg",   title:"はみがき・かお・トイレ", icon:"🧼"},
  {id:"dress", title:"きがえ", icon:"👕"},
  {id:"bag",   title:"にもつチェック", icon:"🎒"}
];
const KIDS=["A","B"];
const cloneTasks=()=>TASKS.map(t=>({...t,done:false,ts:null,dur:null}));
let state = JSON.parse(localStorage.getItem(KEY)||"null") || {
  start: localStorage.getItem(KEY+":start")  || DEFAULT_START,
  depart:localStorage.getItem(KEY+":depart") || DEFAULT_DEPART,
  stars:0,
  kids:{A:{tasks:cloneTasks()},B:{tasks:cloneTasks()}},
  history:[]
};
const save=()=>{localStorage.setItem(KEY,JSON.stringify(state));localStorage.setItem(KEY+":start",state.start);localStorage.setItem(KEY+":depart",state.depart)}

/* ===== DOM ===== */
const $subtitle=document.getElementById("subtitle");
const $start=document.getElementById("startAt");
const $depart=document.getElementById("departAt");
const $count=document.getElementById("countdown");
const $bar=document.getElementById("timeBar");
const $hint=document.getElementById("winHint");
const $stars=document.getElementById("stars");
const $hist=document.getElementById("history");
const $stats=document.getElementById("stats");
const $top=document.getElementById("topCard");

/* ===== 時間ユーティリティ ===== */
const now=()=>new Date();
const parseHM=hm=>{const [h,m]=hm.split(":").map(Number);return {h,m}};
const dateAt=(h,m,base)=>{const d=new Date(base||Date.now()); d.setHours(h,m,0,0); return d;}
function getWindow(){
  const n=now();
  const {h:sh,m:sm}=parseHM(state.start||DEFAULT_START);
  const {h:dh,m:dm}=parseHM(state.depart||DEFAULT_DEPART);
  let start=dateAt(sh,sm,n);
  let depart=dateAt(dh,dm,n);
  // 窓がマイナスにならないよう、出発を過ぎたら翌日に回す
  if(n>depart){ start=new Date(start.getTime()+86400000); depart=new Date(depart.getTime()+86400000); }
  // もし start>=depart になってたら、出発を start+1h に自動調整（表示だけ）
  if(start>=depart){ depart=new Date(start.getTime()+3600000); }
  return {now:n,start,depart};
}
const fmtSec=sec=>{const m=Math.floor(sec/60),s=sec%60;return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}

/* ===== 効果音 ===== */
let audio;
function sfx(k="click"){ try{
  audio = audio || new (window.AudioContext||window.webkitAudioContext)();
  const t0=audio.currentTime; const out=audio.createGain(); out.gain.value=.08; out.connect(audio.destination);
  const beep=(f,t,d,type="sine")=>{const o=audio.createOscillator(),g=audio.createGain();o.type=type;o.frequency.value=f;o.connect(g);g.connect(out);g.gain.setValueAtTime(.0001,t);g.gain.linearRampToValueAtTime(.25,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+d);o.start(t);o.stop(t+d+.02)};
  if(k==="done"){beep(900,t0,.12,"triangle");beep(1200,t0+.08,.1,"triangle")}
  else if(k==="win"){beep(660,t0,.18,"sawtooth");beep(880,t0,.18,"sawtooth");beep(1100,t0,.18,"sawtooth")}
  else{beep(700,t0,.08,"sine")}
}catch(e){}}

/* ===== 紙吹雪 ===== */
const cvs=document.getElementById("cele"), ctx=cvs.getContext("2d");
function resize(){cvs.width=innerWidth;cvs.height=innerHeight} addEventListener("resize",resize); resize();
let parts=[];
function burst(){const x=innerWidth/2,y=80; for(let i=0;i<220;i++){parts.push({x,y,vx:(Math.random()-.5)*8,vy:Math.random()*-9-2,g:.12,size:Math.random()*6+3,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa","#f472b6","#10b981"][i%7],ttl:190})}}
function sprinkleAt(el){const r=el.getBoundingClientRect(),x=r.left+r.width/2,y=r.top+scrollY;for(let i=0;i<36;i++){parts.push({x,y,vx:(Math.random()-.5)*5,vy:Math.random()*-6-2,g:.18,size:Math.random()*5+2,color:["#facc15","#60a5fa","#34d399","#fb7185","#a78bfa","#f472b6","#10b981"][i%7],ttl:110})}}
!function anim(){ctx.clearRect(0,0,cvs.width,cvs.height);parts.forEach(p=>{p.ttl--;p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size)});parts=parts.filter(p=>p.ttl>0&&p.y<cvs.height+30);requestAnimationFrame(anim)}();

/* ===== UI描画 ===== */
function renderKid(kidId){
  const list=document.getElementById("tasks"+kidId); list.innerHTML="";
  const k=state.kids[kidId];
  k.tasks.forEach((t,idx)=>{
    const li=document.createElement("li");
    li.className="flex items-center justify-between p-3 rounded-xl border bg-white";
    li.innerHTML=`
      <div class="flex items-center gap-3">
        <span class="text-2xl">${t.icon}</span>
        <div>
          <div class="font-bold ${t.done?'line-through opacity-60':''}">${t.title}</div>
          <div class="text-[11px] text-gray-500" id="hint-${kidId}-${t.id}">${t.ts?('完了 '+t.ts.slice(11,16)):""}</div>
        </div>
      </div>
      <button class="btn px-4 py-2 rounded-xl font-extrabold text-white ${t.done?'bg-gray-400':'bg-pink-500'}">${t.done?'もどす':'できた！'}</button>
    `;
    const btn=li.querySelector("button");
    let lock=false;
    btn.onclick=()=>{
      if(lock) return; lock=true; setTimeout(()=>lock=false,500);
      const nowIso=new Date().toISOString();
      if(!t.done){
        t.done=true; t.ts=nowIso;
        const prev=(idx>0?k.tasks[idx-1].ts:dateAt(...Object.values(parseHM(state.start))).toISOString());
        t.dur=Math.max(1,Math.floor((new Date(nowIso)-new Date(prev))/1000));
        state.stars++; sfx("done"); sprinkleAt(li);
      }else{
        t.done=false; t.ts=null; t.dur=null; sfx("click");
      }
      save(); render(); if(allDone()) onFinish();
    };
    list.appendChild(li);
  });
  const next=k.tasks.find(x=>!x.done);
  document.getElementById("next"+kidId).textContent = next?`次は「${next.title}」だよ！`:`全部できた！おつかれさま！`;
}

function render(){
  KIDS.forEach(k=>renderKid(k));
  $stars.textContent="⭐"+state.stars;
  $subtitle.textContent=`${state.depart}までに準備しよう`;
}

/* ===== タイマー ===== */
function tick(){
  const {now:n,start,depart}=getWindow();
  const rest=Math.max(0,Math.floor((depart-n)/1000));
  $count.textContent=fmtSec(rest);
  const total=depart-start, pct=Math.min(100,Math.max(0, rest/total*100));
  $bar.style.width=pct+"%";
  $bar.className="h-3 "+(rest>1200?"bg-emerald-500":rest>600?"bg-yellow-400":"bg-red-500");
  $hint.textContent=`時間の窓：${state.start} → ${state.depart}`;
}
setInterval(tick,250);

/* ===== 履歴 & グラフ ===== */
let chart;
function refreshHistory(){
  const items=state.history.slice(-7);
  if(items.length===0){$hist.innerHTML='<div class="text-gray-500">まだ履歴はありません。</div>'; $stats.textContent="平均 --:-- / 最速 --:--";}
  else{
    const avg=Math.round(items.reduce((a,x)=>a+x.totalSec,0)/items.length);
    const best=items.reduce((a,x)=>x.totalSec<a.totalSec?x:a);
    $stats.textContent=`平均 ${fmtSec(avg)} / 最速 ${fmtSec(best.totalSec)}（${best.date}）`;
    $hist.innerHTML=items.slice().reverse().map(h=>`<div class="py-1 border-b last:border-none">${h.date} 完了 ${h.finishedAt}（合計 ${fmtSec(h.totalSec)}）</div>`).join("");
  }
  const labels=state.history.slice(-7).map(x=>x.date);
  const data=state.history.slice(-7).map(x=>Math.round(x.totalSec/60));
  const ctx2=document.getElementById("histChart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx2,{type:"bar",data:{labels,datasets:[{label:"合計時間（分）",data,backgroundColor:["#f472b6","#facc15","#60a5fa","#34d399","#fb7185","#a78bfa","#10b981"]}]},options:{scales:{y:{beginAtZero:true,ticks:{stepSize:5}}},plugins:{legend:{display:false}},responsive:true,maintainAspectRatio:false}});
}
document.getElementById("clearHistory").onclick=()=>{ if(!confirm("履歴をすべて削除しますか？")) return; state.history=[]; save(); refreshHistory(); };

/* ===== 完了判定 & ごほうび ===== */
const allDone=()=>KIDS.every(k=>state.kids[k].tasks.every(t=>t.done));
function onFinish(){
  sfx("win"); burst();
  $top.classList.remove("flash"); void $top.offsetWidth; $top.classList.add("flash");
  const ts=KIDS.flatMap(k=>state.kids[k].tasks.map(t=>t.ts).filter(Boolean)).map(x=>new Date(x)).sort((a,b)=>a-b);
  if(ts.length){
    const totalSec=Math.max(1,Math.floor((ts.at(-1)-ts[0])/1000));
    const rec={date:new Date().toISOString().slice(0,10), finishedAt:new Date().toTimeString().slice(0,5), totalSec};
    state.history.push(rec); save(); refreshHistory();
  }
}

/* ===== イベント ===== */
$start.addEventListener("change",()=>{ state.start=$start.value||DEFAULT_START; save(); tick(); });
$depart.addEventListener("change",()=>{ state.depart=$depart.value||DEFAULT_DEPART; save(); render(); tick(); });

/* ===== 初期化 ===== */
(function init(){
  $start.value=state.start||DEFAULT_START;
  $depart.value=state.depart||DEFAULT_DEPART;
  render(); refreshHistory(); tick();
})();
</script>
</body>
</html>