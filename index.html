<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>朝ダッシュ！ | モーニングルーティン</title>
<style>
  :root{
    --bg:#fffef9; --card:#ffffff; --ink:#1e1f23; --muted:#7a7f87;
    --accent:#2abf77; --accent2:#4f46e5; --danger:#ef4444;
    --shadow:0 8px 24px rgba(0,0,0,.08);
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  header{padding:16px 16px 8px;display:flex;align-items:center;gap:12px;position:sticky;top:0;background:linear-gradient(180deg,#fffef9 70%,transparent);backdrop-filter:saturate(1.2) blur(4px);z-index:2}
  h1{font-size:20px;margin:0}
  .badge{font-size:12px;color:#fff;background:var(--accent2);padding:4px 8px;border-radius:999px}
  .container{padding:0 16px 80px;max-width:720px;margin:0 auto}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
  .row{display:flex;align-items:center;gap:12px}
  .grow{flex:1}
  .time{font-variant-numeric:tabular-nums}
  .timer{font-size:28px;font-weight:700;letter-spacing:.5px}
  .muted{color:var(--muted);font-size:12px}
  .field{display:flex;gap:8px;align-items:center}
  input[type=time]{font-size:16px;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent2);color:#fff;font-weight:700;box-shadow:0 3px 0 rgba(0,0,0,.12);cursor:pointer}
  button.secondary{background:#e5e7eb;color:#111;box-shadow:none}
  button.ghost{background:transparent;color:var(--muted);box-shadow:none}
  button.danger{background:var(--danger)}
  ul#tasks{list-style:none;margin:0;padding:0}
  li.task{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #eef0f3;border-radius:14px;padding:10px 12px;margin:10px 0;touch-action:none}
  .handle{cursor:grab;font-size:18px;color:#9aa1aa}
  .icon{font-size:24px;width:28px;text-align:center}
  .task-main{flex:1}
  .task-title{font-weight:700}
  .bar{height:8px;background:#eef0f3;border-radius:999px;overflow:hidden;margin-top:6px}
  .bar > span{display:block;height:100%;background:var(--accent);width:0%}
  .chip{font-size:11px;background:#f3f4f6;color:#374151;border-radius:999px;padding:3px 8px;margin-left:6px}
  .done{opacity:.55;text-decoration:line-through}
  .right{display:flex;align-items:center;gap:8px}
  .star{font-size:20px}
  footer.fab{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg,transparent,rgba(255,255,255,.9)), #fff;border-top:1px solid #eee;display:flex;gap:8px;justify-content:center}
  .confetti{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
  <header class="row">
    <div style="font-size:28px">⏰</div>
    <div class="grow">
      <h1>朝ダッシュ！ <span class="badge">今日のチャレンジ</span></h1>
      <div class="muted">ぜんぶ終わると花丸が出るよ</div>
    </div>
  </header>

  <div class="container">
    <div class="card row">
      <div class="grow">
        <div class="muted">出発まで</div>
        <div class="timer time" id="countdown">--:--</div>
      </div>
      <div>
        <div class="muted">出発時刻</div>
        <div class="field">
          <input type="time" id="departAt" />
          <button class="secondary" id="startDay">スタート</button>
        </div>
      </div>
    </div>

    <div class="card">
      <ul id="tasks"></ul>
      <div class="row" style="justify-content:space-between;margin-top:4px">
        <button class="ghost" id="resetDay">今日の進捗をリセット</button>
        <div class="muted">長押しまたは「≡」で並び替え</div>
      </div>
    </div>

    <div class="card row">
      <div class="grow">
        <div class="muted">ごほうび</div>
        <div id="stars" class="star" aria-live="polite">⭐ 0</div>
      </div>
      <button class="danger" id="clearAll">すべて初期化</button>
    </div>
  </div>

  <canvas class="confetti" id="confetti"></canvas>

<script>
/** ------- 初期データ ------- **/
const DEFAULT_TASKS = [
  { id:'wake',   title:'おきる',         icon:'🌞', minutes:2 },
  { id:'toilet', title:'トイレ',         icon:'🚽', minutes:3 },
  { id:'wash',   title:'かおをあらう',   icon:'🧼', minutes:3 },
  { id:'meal',   title:'あさごはん',     icon:'🍞', minutes:15 },
  { id:'brush',  title:'はみがき',       icon:'🪥', minutes:3 },
  { id:'dress',  title:'きがえる',       icon:'👕', minutes:5 },
  { id:'bag',    title:'にもつチェック', icon:'🎒', minutes:3 },
  { id:'shoes',  title:'くつをはく',     icon:'👟', minutes:2 },
];
const KEY = 'asaDashV1';
const todayKey = () => {
  const d = new Date(); const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
  return `${KEY}:${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
};
const defaultState = () => ({
  departAt: '08:00',
  tasks: DEFAULT_TASKS.map(t => ({...t, done:false, progress:0})),
  stars: 0,
});
function loadState() {
  const raw = localStorage.getItem(todayKey());
  if (raw) try { return JSON.parse(raw); } catch {}
  // 新しい日になったら初期タスク順も引き継ぎたい：最後の並びがある場合は使う
  const last = localStorage.getItem(KEY+':lastOrder');
  const st = defaultState();
  if (last) {
    const ids = JSON.parse(last);
    st.tasks.sort((a,b)=>ids.indexOf(a.id)-ids.indexOf(b.id));
  }
  // 直近の出発時刻
  const lastDepart = localStorage.getItem(KEY+':lastDepart');
  if (lastDepart) st.departAt = lastDepart;
  return st;
}
function saveState() {
  localStorage.setItem(todayKey(), JSON.stringify(state));
  localStorage.setItem(KEY+':lastOrder', JSON.stringify(state.tasks.map(t=>t.id)));
  localStorage.setItem(KEY+':lastDepart', state.departAt);
}

/** ------- 状態 ------- **/
let state = loadState();

/** ------- DOM参照 ------- **/
const $tasks = document.getElementById('tasks');
const $departAt = document.getElementById('departAt');
const $countdown = document.getElementById('countdown');
const $stars = document.getElementById('stars');
const $startDay = document.getElementById('startDay');
const $resetDay = document.getElementById('resetDay');
const $clearAll = document.getElementById('clearAll');

/** ------- レンダリング ------- **/
function render() {
  $departAt.value = state.departAt;
  $stars.textContent = `⭐ ${state.stars}`;
  $tasks.innerHTML = '';
  state.tasks.forEach((t,i)=>{
    const li = document.createElement('li');
    li.className = 'task';
    li.draggable = true;
    li.dataset.id = t.id;
    li.innerHTML = `
      <div class="handle" title="並び替え">≡</div>
      <div class="icon" aria-hidden="true">${t.icon}</div>
      <div class="task-main ${t.done?'done':''}">
        <div class="task-title">${t.title}
          <span class="chip time">⏱ ${t.minutes}分</span>
        </div>
        <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${t.progress}">
          <span style="width:${t.progress}%"></span>
        </div>
      </div>
      <div class="right">
        <button class="${t.done?'secondary':''}" data-action="toggle">${t.done?'もどす':'できた！'}</button>
        <button class="secondary" data-action="+">+1分</button>
        <button class="secondary" data-action="-">-1分</button>
      </div>
    `;
    // ボタン動作
    li.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const act = btn.dataset.action;
        const task = state.tasks.find(x=>x.id===t.id);
        if (act==='toggle') {
          task.done = !task.done;
          if (task.done) task.progress = 100;
          chime(task.done ? 'done':'click');
          if (allDone()) celebrate();
        } else if (act==='+') {
          task.progress = Math.min(100, task.progress + Math.round(100/(task.minutes||1)));
        } else if (act==='-') {
          task.progress = Math.max(0, task.progress - Math.round(100/(task.minutes||1)));
        }
        saveState(); render();
      });
    });
    // DnD
    li.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', t.id);
    });
    li.addEventListener('dragover', (e)=>{ e.preventDefault(); li.style.background='#f7f7fb'; });
    li.addEventListener('dragleave', ()=>{ li.style.background='#fff'; });
    li.addEventListener('drop',(e)=>{
      e.preventDefault(); li.style.background='#fff';
      const fromId = e.dataTransfer.getData('text/plain');
      const toId = t.id;
      if (fromId===toId) return;
      const arr = state.tasks;
      const from = arr.findIndex(x=>x.id===fromId);
      const to = arr.findIndex(x=>x.id===toId);
      const [moved] = arr.splice(from,1);
      arr.splice(to,0,moved);
      chime('move'); saveState(); render();
    });
    $tasks.appendChild(li);
  });
}
function allDone(){ return state.tasks.every(t=>t.done); }

/** ------- 時刻・タイマー ------- **/
function tick(){
  // 残り時間
  const [hh,mm] = state.departAt.split(':').map(Number);
  const now = new Date();
  const dep = new Date(now);
  dep.setHours(hh, mm, 0, 0);
  let ms = dep - now;
  let neg = false;
  if (ms < 0) { neg = true; ms = -ms; }
  const m = Math.floor(ms/60000);
  const s = Math.floor((ms%60000)/1000);
  $countdown.textContent = `${neg?'-':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  requestAnimationFrame(()=>{}); // noop for smoother paint
}
setInterval(tick, 500);

/** ------- ごほうび & 演出 ------- **/
function celebrate(){
  state.stars += 1; saveState(); render(); confettiBurst(); chime('celebrate');
}

/** ------- 音（WebAudioで軽量ビープ） ------- **/
let audioCtx;
function chime(type='click'){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    const map = {
      click:{f:660, dur:0.06},
      done:{f:880, dur:0.12},
      move:{f:520, dur:0.06},
      celebrate:{f:1040, dur:0.18},
    };
    const {f, dur} = map[type] || map.click;
    o.frequency.value = f; g.gain.value=.06;
    const t = audioCtx.currentTime;
    o.start(t); o.stop(t+dur);
  }catch(e){}
}

/** ------- コンフェッティ ------- **/
const canvas = document.getElementById('confetti');
const ctx = canvas.getContext('2d');
let confs = [];
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener('resize', resize); resize();
function confettiBurst(){
  const colors = ['#facc15','#60a5fa','#34d399','#fb7185','#a78bfa'];
  for(let i=0;i<120;i++){
    confs.push({
      x: canvas.width/2, y: 40,
      vx: (Math.random()-0.5)*6, vy: Math.random()*-6-2,
      g: 0.12, size: Math.random()*6+3, color: colors[Math.floor(Math.random()*colors.length)], ttl: 160
    });
  }
}
function anim(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  confs.forEach(p=>{
    p.ttl--; p.vy += p.g; p.x += p.vx; p.y += p.vy;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size);
  });
  confs = confs.filter(p=>p.ttl>0 && p.y < canvas.height+20);
  requestAnimationFrame(anim);
}
anim();

/** ------- イベント ------- **/
$departAt.addEventListener('change',()=>{
  state.departAt = $departAt.value || '08:00';
  saveState(); tick();
});
$startDay.addEventListener('click', ()=>{
  // 進捗0 & 完了解除（順番は保持）
  state.tasks.forEach(t=>{ t.done=false; t.progress=0; });
  saveState(); render(); chime('click');
});
$resetDay.addEventListener('click', ()=>{
  if (!confirm('今日の進捗をリセットしますか？')) return;
  state.tasks.forEach(t=>{ t.done=false; t.progress=0; });
  saveState(); render();
});
$clearAll.addEventListener('click', ()=>{
  if (!confirm('データをすべて初期化しますか？（今日・履歴・設定）')) return;
  Object.keys(localStorage).forEach(k=>{
    if (k.startsWith(KEY)) localStorage.removeItem(k);
  });
  state = defaultState(); saveState(); render();
});

/** ------- 初期表示 ------- **/
render(); tick();
</script>
</body>
</html>
